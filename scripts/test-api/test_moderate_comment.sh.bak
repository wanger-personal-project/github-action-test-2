#!/bin/bash

# 审核评论 API（仅文章作者）
# 用法: ./test_moderate_comment.sh <cookie_file> <comment_id> <status>

set -e

BASE_URL="${API_BASE_URL:-http://localhost:3000}"

if [ $# -lt 3 ]; then
  echo "Usage: $0 <cookie_file> <comment_id> <status>"
  echo "Status: approved | rejected | spam"
  echo "Example: $0 /tmp/session.txt 'comment-uuid' approved"
  exit 1
fi

COOKIE_FILE="$1"
COMMENT_ID="$2"
STATUS="$3"

if [ ! -f "$COOKIE_FILE" ]; then
  echo "Error: Cookie file not found: $COOKIE_FILE"
  exit 1
fi

# 验证状态值
if [[ ! "$STATUS" =~ ^(approved|rejected|spam)$ ]]; then
  echo "Error: Status must be 'approved', 'rejected', or 'spam'"
  exit 1
fi

echo "========================================="
echo "Testing Moderate Comment API"
echo "========================================="
echo "Comment ID: $COMMENT_ID"
echo "Status: $STATUS"
echo "Using session: $COOKIE_FILE"
echo ""

curl -X PUT "$BASE_URL/api/comments/moderate" \
  -H "Content-Type: application/json" \
  -b "$COOKIE_FILE" \
  -d "{\"comment_id\": \"$COMMENT_ID\", \"status\": \"$STATUS\"}" \
  -w "\n\nHTTP Status: %{http_code}\n" \
  2>/dev/null | python3 -m json.tool 2>/dev/null || cat

echo ""
echo "========================================="
